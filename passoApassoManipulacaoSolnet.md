# üìö DOCUMENTA√á√ÉO COMPLETA: Implementa√ß√£o de "Confirmar Divergentes" na Concilia√ß√£o Banc√°ria

## üéØ Vis√£o Geral da Issue #7351

**T√≠tulo:** [SOL.NET](http://sol.net/) - Concilia√ß√£o Banc√°ria - Aceitar Diverg√™ncias PIX/Cart√£o

**Problema:** Valores de recebimentos via PIX e Cart√£o apresentam pequenas diferen√ßas (arredondamentos) entre o sistema e o extrato banc√°rio, impedindo a concilia√ß√£o autom√°tica.

**Solu√ß√£o Implementada:** Bot√£o "Confirmar Divergentes" que permite aceitar essas pequenas diferen√ßas e ajustar automaticamente o valor no lado do sistema.

---

## üìñ Gloss√°rio de Termos T√©cnicos

| Termo | Significado |
| --- | --- |
| **DDL (Data Definition Language)** | Linguagem de defini√ß√£o de dados - usada para criar/alterar estruturas de banco de dados |
| **Builder** | Padr√£o de projeto que constr√≥i objetos complexos passo a passo (no caso, comandos SQL) |
| **CDS (TClientDataSet)** | Componente Delphi que armazena dados em mem√≥ria, como uma tabela tempor√°ria |
| **DAL (Data Access Layer)** | Camada de Acesso a Dados - respons√°vel por comunica√ß√£o com o banco |
| **Form** | Janela/Tela da aplica√ß√£o (Interface do Usu√°rio) |
| **Grid (DBGrid)** | Componente visual que exibe dados em formato de tabela |
| **DataSource** | Componente que conecta um CDS a componentes visuais |
| **Query/SQL** | Consulta ao banco de dados |
| **Transaction** | Conjunto de opera√ß√µes que devem ser executadas como uma unidade (tudo ou nada) |
| **Commit** | Confirmar/Salvar altera√ß√µes no banco |
| **Rollback** | Desfazer altera√ß√µes no banco |
| **Auditoria** | Registro de quem fez o qu√™ e quando no sistema |

---

## üèóÔ∏è PASSO 1: Criar Campo no Banco de Dados

### üìç Arquivo: `uProcessosAtualizacaoPrincipal.pas`

### O que √© o TDDLBuilder?

O **TDDLBuilder** √© uma classe auxiliar que facilita a cria√ß√£o de comandos SQL para alterar estruturas de banco de dados. Em vez de escrever SQL manualmente, voc√™ usa m√©todos encadeados.

### C√≥digo Adicionado

```
builder := TDDLBuilder.Create(ddlAlter, 'CONCILIACAO_BANCARIA')
  .AddCampo('VL_FINAL_ORIGINAL', tcNumeric, 0, 15, 5);
Executar(TGUID.Create('{079011FA-9216-4F75-88F7-F52C4F129531}'), builder.ToString);
TryFreeAndNil(builder);

```

### Explica√ß√£o Detalhada

### `TDDLBuilder.Create(ddlAlter, 'CONCILIACAO_BANCARIA')`

- **ddlAlter**: Tipo de opera√ß√£o (ALTER TABLE - modificar tabela existente)
- **'CONCILIACAO_BANCARIA'**: Nome da tabela que ser√° alterada

### `.AddCampo('VL_FINAL_ORIGINAL', tcNumeric, 0, 15, 5)`

Adiciona um novo campo (coluna) na tabela:

| Par√¢metro | Valor | Significado |
| --- | --- | --- |
| **Nome do Campo** | `VL_FINAL_ORIGINAL` | Nome da coluna que ser√° criada |
| **Tipo** | `tcNumeric` | Tipo num√©rico (aceita casas decimais) |
| **Par√¢metro 1** | `0` | Valor padr√£o inicial (zero) |
| **Par√¢metro 2** | `15` | Precis√£o total (15 d√≠gitos no total) |
| **Par√¢metro 3** | `5` | Escala (5 casas decimais) |

**Exemplo de valor:** `9999999999.99999` (10 d√≠gitos antes da v√≠rgula + 5 depois)

### `Executar(TGUID.Create(...), builder.ToString)`

- **TGUID**: Identificador √∫nico para esta atualiza√ß√£o
- Se este GUID j√° foi executado antes, o sistema pula (evita duplica√ß√£o)
- `builder.ToString`: Converte o builder em comando SQL real

### SQL Gerado (aproximadamente)

```sql
ALTER TABLE CONCILIACAO_BANCARIA
ADD VL_FINAL_ORIGINAL NUMERIC(15,5) DEFAULT 0;

```

### Por que criar este campo?

Este campo armazenar√° o **valor original** do Controle Financeiro antes de ser alterado pela confirma√ß√£o de diverg√™ncia. Assim, quando desfizer a concilia√ß√£o, o sistema pode restaurar o valor correto.

---

## üîç PASSO 2: Modificar a Consulta SQL (DAL)

### üìç Arquivo: `uDalCaixaGeral.pas`

### O que √© a DAL?

A **DAL (Data Access Layer)** √© a camada respons√°vel por todas as comunica√ß√µes com o banco de dados. Ela cont√©m fun√ß√µes que:

- Buscam dados (SELECT)
- Atualizam dados (UPDATE)
- Inserem dados (INSERT)
- Deletam dados (DELETE)

### Fun√ß√£o Modificada: `SqlBuscarConciliacaoOFX`

### Antes (com coment√°rios)

```
strSql.Append('SELECT                         ' + BR);
strSql.Append('  CF.*,                        ' + BR);
// strSql.Append('  0 AS OPCAO,                ' + BR);
// strSql.Append('  0 AS SEL_AUT               ' + BR);
// Modified by hetos 26/03/2020 10:43:06 SQLSERVER
strSql.Append(' CAST(0 AS INTEGER) AS OPCAO,  ' + BR);
strSql.Append(' CAST(0 AS INTEGER) AS SEL_AUT ' + BR);

```

### Depois (limpo)

```
strSql.Append('SELECT                         ' + BR);
strSql.Append('  CF.*,                        ' + BR);

strSql.Append(' CAST(0 AS INTEGER) AS OPCAO,  ' + BR);
strSql.Append(' CAST(0 AS INTEGER) AS SEL_AUT ' + BR);

```

### Por que Remover Coment√°rios?

**Boa Pr√°tica - Clean Code:**

- Coment√°rios desatualizados confundem mais do que ajudam
- Hist√≥rico de mudan√ßas j√° est√° no Git/GitHub
- C√≥digo deve ser autoexplicativo
- Coment√°rios devem explicar "por qu√™", n√£o "o qu√™"

### Outras Limpezas na Mesma Fun√ß√£o

```
// ‚ùå ANTES - Coment√°rios desnecess√°rios
// Entrada ou Saida
// if (numTpEntradaSaida < 2) then
// begin
//   strSql.Append('AND (CF.TP_ENTRADA_SAIDA = ' + numTpEntradaSaida.ToString + ') ');
// end;

// Modified by hetos 01/08/2019 10:01:05
if OculsarPrevisao = 1 then
  strSql.Append('AND (CF.TP_PREVISAO = 0 OR CF.TP_PREVISAO IS NULL) ');

// ‚úÖ DEPOIS - C√≥digo limpo
if OculsarPrevisao = 1 then
  strSql.Append('AND (CF.TP_PREVISAO = 0 OR CF.TP_PREVISAO IS NULL) ');

```

### Corre√ß√£o de Indenta√ß√£o

### Antes (indenta√ß√£o inconsistente)

```
var cdsTaxa: TClientDataSet := TClientDataSet.Create(nil);
try
   try
    strSql.Clear;
    cdsTaxa.Data := Dados.QryOpenOle(...);
  except
    on E: Exception do
    begin
      raise Exception.Create(...);
    end;
  end;
finally
  TryFreeAndNil(cdsTaxa);
end;

```

### Depois (indenta√ß√£o correta)

```
var cdsTaxa: TClientDataSet := TClientDataSet.Create(nil);
try
  try
    strSql.Clear;
    cdsTaxa.Data := Dados.QryOpenOle(...);
  except
    on E: Exception do
    begin
      raise Exception.Create(...);
    end;
  end;
finally
  TryFreeAndNil(cdsTaxa);
end;

```

**Por qu√™?** C√≥digo alinhado √© mais f√°cil de ler e entender a estrutura l√≥gica.

---

## üé® PASSO 3: Criar o Bot√£o na Interface (Form)

### üìç Arquivo: `uFrmCaixaGeral.dfm` (Design do Form)

### O que foi adicionado?

```
object btnCBConfirmarDiv: TBitBtn
  AlignWithMargins = True
  Left = 171
  Top = 2
  Width = 134
  Height = 37
  Cursor = crHandPoint
  Caption = 'Confirmar Divergentes'
  TabOrder = 3
  OnClick = btnCBConfirmarDivClick
end

```

### Propriedades do Bot√£o

| Propriedade | Valor | Significado |
| --- | --- | --- |
| **Name** | `btnCBConfirmarDiv` | Identificador √∫nico do componente |
| **Caption** | `'Confirmar Divergentes'` | Texto exibido no bot√£o |
| **Cursor** | `crHandPoint` | Cursor vira "m√£ozinha" ao passar por cima |
| **OnClick** | `btnCBConfirmarDivClick` | M√©todo executado ao clicar |
| **TabOrder** | `3` | Ordem de navega√ß√£o pelo Tab |

### Prefixos de Nomenclatura

| Prefixo | Tipo de Componente |
| --- | --- |
| **btn** | Bot√£o (Button/BitBtn) |
| **txt** | Campo de texto (Edit) |
| **cds** | ClientDataSet |
| **dbg** | DBGrid (Grade de dados) |
| **pnl** | Panel (Painel) |
| **lbl** | Label (R√≥tulo) |

---

## üíª PASSO 4: Implementar a L√≥gica do Bot√£o

### üìç Arquivo: `uFrmCaixaGeral.pas`

### Declara√ß√£o do Evento

```
type
  TFrmCaixaGeral = class(TFrmHeranca)
    // ... outros componentes ...
    btnCBConfirmarDiv: TBitBtn;  // ‚Üê Declara√ß√£o do bot√£o

    // ... outros procedures ...
    procedure btnCBConfirmarDivClick(Sender: TObject);  // ‚Üê Declara√ß√£o do evento
  end;

```

### Implementa√ß√£o Completa com Coment√°rios Explicativos

```
procedure TFrmCaixaGeral.btnCBConfirmarDivClick(Sender: TObject);
begin
  inherited; // ‚Üê Chama m√©todo da classe pai (se existir)

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // VALIDA√á√ÉO 1: Verificar se h√° dados para processar
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  if (cdsOFX.EstaVazio) or (cdsOP.EstaVazio) then
    Exit; // Sai do procedimento se n√£o houver dados

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CRIA√á√ÉO DE DATASETS TEMPOR√ÅRIOS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Criamos c√≥pias tempor√°rias para n√£o mexer nos dados originais
  var cdsRegBancario: TClientDataSet := TClientDataSet.Create(Self);
  var cdsRegCaixaGeral: TClientDataSet := TClientDataSet.Create(Self);
  try
    // Copiar dados do extrato banc√°rio (OFX)
    cdsRegBancario.Data := cdsOFX.Data;
    cdsRegBancario.Filtrar('OPCAO = 1'); // ‚Üê Filtra apenas registros selecionados

    // Copiar dados do sistema (Controle Financeiro)
    cdsRegCaixaGeral.Data := cdsOP.Data;
    cdsRegCaixaGeral.Filtrar('OPCAO = 1'); // ‚Üê Filtra apenas registros selecionados

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VALIDA√á√ÉO 2: Permitir apenas 1 registro de cada lado
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (cdsRegBancario.RecordCount > 1) or (cdsRegCaixaGeral.RecordCount > 1) then
    begin
      Geral.Men('N√£o √© poss√≠vel confirmar registros m√∫ltiplos com diverg√™ncia.' + BR +
                'Selecione apenas 1 registo em cada lado!');
      Exit;
    end;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VALIDA√á√ÉO 3: Verificar se registros j√° est√£o conciliados
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (cdsRegCaixaGeral.FieldByName('TP_CONCILIADO').AsInteger = 1) then
    begin
      Geral.Men('N√£o Perminito Selecionar um Registro J√° "Conciliado" - Caixa Geal');
      Exit;
    end;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VALIDA√á√ÉO 4: Verificar se pagamento foi compensado
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if not(cdsRegCaixaGeral.FieldByName('TP_STATUS').AsInteger > 0) then
    begin
      Geral.Men('N√£o Perminito Selecionar um Registro "N√£o Compensado" - Caixa Geal');
      Exit;
    end;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VALIDA√á√ÉO 5: Verificar registro banc√°rio
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (cdsRegBancario.FieldByName('TP_CONCILIADO').AsInteger = 1) then
    begin
      Geral.Men('N√£o Perminito Selecionar um Registro J√° "Conciliado" - Banco');
      Exit;
    end;

    if (cdsRegBancario.FieldByName('TP_PREVISAO').AsInteger = 1) then
    begin
      Geral.Men('N√£o Perminito Selecionar um Registro "Previs√£o" - Banco');
      Exit;
    end;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CAPTURAR VALORES E CALCULAR DIFEREN√áA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    var IdControleFinanceiro: Double := cdsRegCaixaGeral.FieldByName('ID_CONTROLE_FINANCEIRO').AsFloat;
    var IdConciliacaoBancaria: Double := cdsRegBancario.FieldByName('ID_CONCILIACAO_BANCARIA').AsFloat;
    var ValorRegBancario: Double := cdsRegBancario.FieldByName('VALOR').AsFloat;
    var ValorRegCaixa: Double := cdsRegCaixaGeral.FieldByName('VALOR').AsFloat;
    var DiferencaValor: Double := (ValorRegCaixa - ValorRegBancario);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIRMA√á√ÉO DO USU√ÅRIO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if not Geral.MenConfirmar(
      'Os registro tem uma diferen√ßa de Valor (' +
      Geral.FormatarValor(DiferencaValor, 2, False, True) + ')!' + BR +
      'Deseja confirmar diverg√™ncia?'
    ) then
    begin
      Exit;
    end;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INICIAR TRANSA√á√ÉO NO BANCO DE DADOS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    Dados.InicairTransaction;
    try
      // Gerar ID √∫nico para vincular os dois registros
      var idVinculoInd: Double := Dados.IdGeral('CONCILIACAO_BANCARIA_VINC');

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // ATUALIZAR CONTROLE FINANCEIRO (Sistema)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      Dados.QryExecutar(
        'UPDATE CONTROLE_FINANCEIRO ' +
        'SET TP_CONCILIADO = 2, ' +          // ‚Üê Marca como conciliado com diverg√™ncia
        '    ID_VINCULO_CB = :ID_VINCULO_CB, ' +
        '    VALOR = :VALOR ' +               // ‚Üê ALTERA VALOR PARA O DO BANCO
        'WHERE ID_CONTROLE_FINANCEIRO = :ID_CONTROLE_FINANCEIRO',
        varArrayOf([idVinculoInd, ValorRegBancario, IdControleFinanceiro])
      );

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // ATUALIZAR CONCILIA√á√ÉO BANC√ÅRIA
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      Dados.QryExecutar(
        'UPDATE CONCILIACAO_BANCARIA ' +
        'SET TP_CONCILIADO = 2, ' +
        '    ID_VINCULO_CB = :ID_VINCULO_CB, ' +
        '    VL_FINAL_ORIGINAL = :VL_FINAL_ORIGINAL ' +  // ‚Üê GUARDA VALOR ORIGINAL
        'WHERE ID_CONCILIACAO_BANCARIA = :ID_CONCILIACAO_BANCARIA',
        varArrayOf([idVinculoInd, ValorRegCaixa, IdConciliacaoBancaria])
      );

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // GRAVAR AUDITORIA
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      varDadosOriginalAuditoria.Clear;
      varDadosModificadosAuditoria.Clear;

      varDadosOriginalAuditoria.Append('Concilia√ß√£o bancaria com diverg√™ncia' + BR);
      varDadosOriginalAuditoria.Append('Valor : ' + Geral.ConverteParaString(ValorRegCaixa) + BR);

      varDadosModificadosAuditoria.Append('Concilia√ß√£o bancaria com diverg√™ncia' + BR);
      varDadosModificadosAuditoria.Append('Valor : ' + Geral.ConverteParaString(ValorRegBancario) + BR);

      GravarAuditoria(Self, nil, 'CONTROLE_FINANCEIRO', 'E', IdControleFinanceiro);

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // CONFIRMAR ALTERA√á√ïES NO BANCO
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      Dados.Commit;

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // ATUALIZAR VISUAL (CDS em mem√≥ria)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      cdsOP.Localizar('ID_CONTROLE_FINANCEIRO', IdControleFinanceiro);
      cdsOP.Edit;
      cdsOP.FieldByName('VALOR').AsFloat := ValorRegBancario;
      cdsOP.FieldByName('TP_CONCILIADO').AsFloat := 1;
      cdsOP.Post;

      cdsOFX.Localizar('ID_CONCILIACAO_BANCARIA', IdConciliacaoBancaria);
      cdsOFX.Edit;
      cdsOFX.FieldByName('TP_CONCILIADO').AsFloat := 1;
      cdsOFX.Post;

    except
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // EM CASO DE ERRO: DESFAZER TUDO
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      Dados.Rollback;
    end;

  finally
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LIBERAR MEM√ìRIA DOS DATASETS TEMPOR√ÅRIOS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    TryFreeAndNil(cdsRegBancario, cdsRegCaixaGeral);
  end;
end;

```

---

## üîÑ Como Descobrir qual CDS Usar?

### M√©todo 1: Verificar o DataSource do Grid

1. **Clique no Grid** (dbgOFX ou dbgOP)
2. **Procure a propriedade `DataSource`**
3. O DataSource aponta para um CDS

```
dbgOFX ‚Üí DataSource: dsOFX ‚Üí Dataset: cdsOFX

```

### M√©todo 2: Buscar por `.Data` no C√≥digo

Procure no c√≥digo onde o CDS recebe dados:

```
// Exemplo encontrado
cdsOFX.Data := DalCaixaGeral.SqlBuscarConciliacaoOFX(
  parametrosOFX,
  cbxVisCampoPesquisadoConBanc,
  cbxVisCondicaoConBanc.AsStringValor,
  txtVisBuscarConBanc
);

```

**Ao clicar** em `SqlBuscarConciliacaoOFX`, voc√™ √© levado √† consulta SQL!

### M√©todo 3: Verificar Declara√ß√£o do CDS

No in√≠cio do Form:

```
private
  cdsOP: TClientDataSet;   // ‚Üê Dados do sistema
  cdsOFX: TClientDataSet;  // ‚Üê Dados do banco

```

---

## üìä Fluxo Completo da Funcionalidade

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. USU√ÅRIO SELECIONA REGISTROS DIVERGENTES                 ‚îÇ
‚îÇ    ‚úì 1 registro do sistema (cdsOP)                         ‚îÇ
‚îÇ    ‚úì 1 registro do banco (cdsOFX)                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. CLICA EM "CONFIRMAR DIVERGENTES"                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. VALIDA√á√ïES                                               ‚îÇ
‚îÇ    ‚úì H√° dados?                                              ‚îÇ
‚îÇ    ‚úì S√≥ 1 registro de cada lado?                            ‚îÇ
‚îÇ    ‚úì N√£o est√£o conciliados?                                 ‚îÇ
‚îÇ    ‚úì Pagamento compensado?                                  ‚îÇ
‚îÇ    ‚úì N√£o √© previs√£o?                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. CALCULAR DIFEREN√áA E CONFIRMAR COM USU√ÅRIO               ‚îÇ
‚îÇ    "Diferen√ßa de R$ 0,05. Confirmar?"                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. ATUALIZAR BANCO DE DADOS (Transaction)                   ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ    ‚îÇ CONTROLE_FINANCEIRO:                        ‚îÇ          ‚îÇ
‚îÇ    ‚îÇ  - TP_CONCILIADO = 2 (diverg√™ncia)         ‚îÇ          ‚îÇ
‚îÇ    ‚îÇ  - VALOR = valor do banco (ajustado)        ‚îÇ          ‚îÇ
‚îÇ    ‚îÇ  - ID_VINCULO_CB = ID √∫nico gerado          ‚îÇ          ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ    ‚îÇ CONCILIACAO_BANCARIA:                       ‚îÇ          ‚îÇ
‚îÇ    ‚îÇ  - TP_CONCILIADO = 2                        ‚îÇ          ‚îÇ
‚îÇ    ‚îÇ  - ID_VINCULO_CB = mesmo ID                 ‚îÇ          ‚îÇ
‚îÇ    ‚îÇ  - VL_FINAL_ORIGINAL = valor original ‚òÖ     ‚îÇ          ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. GRAVAR AUDITORIA                                         ‚îÇ
‚îÇ    Antes: R$ 100,05                                         ‚îÇ
‚îÇ    Depois: R$ 100,00                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. COMMIT (Confirmar altera√ß√µes)                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 8. ATUALIZAR VISUAL (CDS em mem√≥ria)                        ‚îÇ
‚îÇ    Grid mostra registros como conciliados                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

```

---

## üîë Conceitos Importantes

### 1. Por que usar `try...finally`?

```
var cds: TClientDataSet := TClientDataSet.Create(nil);
try
  // ... usar cds ...
finally
  TryFreeAndNil(cds); // ‚Üê SEMPRE EXECUTA, mesmo com erro
end;

```

**Motivo:** Evitar **vazamento de mem√≥ria** (memory leak). Se n√£o liberar, o objeto fica na mem√≥ria para sempre.

### 2. Por que usar `try...except` dentro de Transaction?

```
Dados.InicairTransaction;
try
  // Opera√ß√µes no banco
  Dados.Commit;
except
  Dados.Rollback; // ‚Üê Desfaz TUDO em caso de erro
end;

```

**Motivo:** **Atomicidade** - ou todas as opera√ß√µes funcionam, ou nenhuma funciona.

### 3. O que s√£o os `varArrayOf`?

```
Dados.QryExecutar(
  'UPDATE TABELA SET CAMPO = :VALOR WHERE ID = :ID',
  varArrayOf([123.45, 789])  // ‚Üê Substitui :VALOR e :ID
);

```

**Motivo:** Evitar **SQL Injection** e facilitar passagem de par√¢metros.

### 4. Por que atualizar CDS ap√≥s Commit?

```
Dados.Commit; // ‚Üê Salva no banco

cdsOP.Edit;   // ‚Üê Atualiza visual
cdsOP.FieldByName('VALOR').AsFloat := NovoValor;
cdsOP.Post;

```

**Motivo:** O CDS √© uma **c√≥pia em mem√≥ria** dos dados. Se n√£o atualizar, o usu√°rio v√™ dados desatualizados.

---

## ‚ö†Ô∏è Pr√≥ximos Passos (Issue #7105)

Como mencionado anteriormente, **falta implementar a restaura√ß√£o do valor** no bot√£o "Desfazer":

```
// NO BOT√ÉO DESFAZER:
// 1. Buscar VL_FINAL_ORIGINAL da CONCILIACAO_BANCARIA
// 2. Restaurar VALOR original no CONTROLE_FINANCEIRO
// 3. Limpar VL_FINAL_ORIGINAL (deixar NULL)

```

---

## üìù Checklist de Boas Pr√°ticas Aplicadas

- ‚úÖ **Campo criado com DDLBuilder** (evita SQL manual)
- ‚úÖ **GUID √∫nico** para controle de vers√£o do banco
- ‚úÖ **C√≥digo limpo** (coment√°rios antigos removidos)
- ‚úÖ **Indenta√ß√£o consistente**
- ‚úÖ **Valida√ß√µes robustas** (m√∫ltiplas verifica√ß√µes)
- ‚úÖ **Transa√ß√µes at√¥micas** (commit/rollback)
- ‚úÖ **Auditoria completa** (antes/depois registrados)
- ‚úÖ **Libera√ß√£o de mem√≥ria** (TryFreeAndNil)
- ‚úÖ **SQL parametrizado** (seguran√ßa contra injection)
- ‚úÖ **Atualiza√ß√£o visual** (CDS sincronizado)

---

## üéì Resumo para Iniciantes

### O que a Issue Pedia?

"Permitir confirmar concilia√ß√µes banc√°rias mesmo quando h√° pequenas diferen√ßas de valor (arredondamentos do PIX/Cart√£o)"

### O que foi Feito?

1. **Criado campo `VL_FINAL_ORIGINAL`** ‚Üí Guarda valor antes de alterar
2. **Limpado c√≥digo SQL** ‚Üí Removidos coment√°rios antigos
3. **Criado bot√£o visual** ‚Üí Interface para usu√°rio
4. **Implementada l√≥gica completa** ‚Üí Valida√ß√µes + Banco + Auditoria

### Fluxo Resumido

```
Usu√°rio ‚Üí Seleciona 2 registros com diferen√ßa pequena
       ‚Üì
Sistema ‚Üí Valida tudo
       ‚Üì
Usu√°rio ‚Üí Confirma diferen√ßa
       ‚Üì
Sistema ‚Üí Ajusta valor do sistema = valor do banco
       ‚Üì
Sistema ‚Üí Guarda valor original para poder desfazer depois
       ‚Üì
Conclu√≠do ‚Üí Registros aparecem conciliados na tela

```

---

**Documenta√ß√£o criada em:** 28/01/2025

**Autor:** Copilot

**Baseado na Issue:** #7351

**Pull Request:** #7419

**Vers√£o [Sol.NET](http://sol.net/):** 12.2
