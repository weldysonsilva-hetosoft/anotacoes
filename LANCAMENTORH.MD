# üìã GUIA DE IMPLEMENTA√á√ÉO - Issue #7563

**Issue:** 246926: SOL.NET - ERROS - LANCAMENTO RH AO INSERIR UM D√âBITO COM PORTADOR 'A VISTA' AVISO DE 'N√ÉO PERMITIDO'

**Branch:** `7563-246926-solnet---erros---lancamento-rhao-inserir-um-debito-com-portador-a-vista-aviso-de-n`

---

## üéØ OBJETIVO

Filtrar os comboboxes de **Portadores** e **Tipos de Documentos** baseado no **Tipo de Opera√ß√£o** selecionado (Cr√©dito/D√©bito/Saldo), tanto no **Cadastro RH** quanto no **Lan√ßamento RH**.

**Problema:** O sistema estava listando TODOS os portadores e tipos de documentos, independente da opera√ß√£o selecionada. Isso permitia que o usu√°rio selecionasse um portador incompat√≠vel (ex: Boleto - Entrada quando a opera√ß√£o era D√©bito - Sa√≠da), gerando erro "N√£o Permitido" na valida√ß√£o.

**Solu√ß√£o:** Filtrar dinamicamente os comboboxes para mostrar apenas portadores e documentos compat√≠veis com a opera√ß√£o selecionada.

---

## üìÇ ARQUIVO 1: `uFrmCadastroRH.pas`

### **PASSO 1: Adicionar declara√ß√£o dos m√©todos (Se√ß√£o Protected)**

üìç **Localiza√ß√£o:** Por volta da linha 280, antes de `public`

**Encontre:**
```pascal
    procedure QuantidadeRegistroMassa;
    function LancamentoEmMassaRH: Boolean;
    // FRIMFORMULARIO
  public
    { Public declarations }
```

**Substitua por:**
```pascal
    procedure QuantidadeRegistroMassa;
    function LancamentoEmMassaRH: Boolean;
    
    procedure PreencherPortadoresRH;
    procedure PreencherTiposDocumentosRH;
    // FRIMFORMULARIO
  public
    { Public declarations }
```

---

### **PASSO 2: Modificar o CarregarCombos**

üìç **Localiza√ß√£o:** Por volta da linha 1733

**ANTES:**
```pascal
procedure TFrmCadastroRH.CarregarCombos;
begin
  inherited;

  cds.Limpar(cdsAux1);
  cdsAux1.Data := Dados.SqlBuscarEmpresas;
  cbxVisIdEmpresaCad.Preencher(cdsAux1, [0, 1], -1, True);
  cbxVisIdEmpresaCad2.Preencher(cdsAux1, [0, 1], -1, True);
  cbxEmpresaRH.Preencher(cdsAux1, [0, 1]);

  cds.Limpar(cdsSistema);
  cdsSistema.Data := Dados.BuscarGeral('TIPOS_DOCUMENTOS', 'DESCRICAO');
  cbxTipoDocumentoRH.Preencher(cdsSistema, ['ID_TIPO_DOCUMENTO', 'DESCRICAO']);

  cds.Limpar(cdsSistema);
  cdsSistema.Data := Dados.BuscarGeral('PORTADORES', 'DESCRICAO');
  cbxPortadorRH.Preencher(cdsSistema, ['ID_PORTADOR', 'DESCRICAO']);
end;
```

**DEPOIS:**
```pascal
procedure TFrmCadastroRH.CarregarCombos;
begin
  inherited;

  cds.Limpar(cdsAux1);
  cdsAux1.Data := Dados.SqlBuscarEmpresas;
  cbxVisIdEmpresaCad.Preencher(cdsAux1, [0, 1], -1, True);
  cbxVisIdEmpresaCad2.Preencher(cdsAux1, [0, 1], -1, True);
  cbxEmpresaRH.Preencher(cdsAux1, [0, 1]);

  PreencherTiposDocumentosRH;
  PreencherPortadoresRH;
  cbxTipoOperacaoRH.OnChange := cbxTipoOperacaoRHChange;
end;
```

---

### **PASSO 3: Adicionar os NOVOS m√©todos**

üìç **Localiza√ß√£o:** Logo ap√≥s o m√©todo `CarregarCombos`

**Adicione estes 3 m√©todos:**

```pascal
procedure TFrmCadastroRH.PreencherTiposDocumentosRH;
var TipoES: Integer;
begin
  TipoES := 2; // default all
  if cbxTipoOperacaoRH.AsInteger = 0 then
    TipoES := 0 // Entrada (Cr√©dito)
  else if cbxTipoOperacaoRH.AsInteger = 1 then
    TipoES := 1 // Saida (D√©bito)
  else if cbxTipoOperacaoRH.AsInteger = 2 then
    TipoES := 1; // Saldo (D√©bito)
  
  cds.Limpar(cdsSistema);
  if TipoES = 2 then
    cdsSistema.Data := Dados.BuscarGeral('TIPOS_DOCUMENTOS', 'DESCRICAO')
  else
  begin
    cdsSistema.Data := Dados.QryOpenOle(
      'SELECT * FROM TIPOS_DOCUMENTOS WHERE (TP_ENTRADA_SAIDA = ' + TipoES.ToString + ' OR TP_ENTRADA_SAIDA = 2) ORDER BY DESCRICAO');
  end;
  cbxTipoDocumentoRH.Preencher(cdsSistema, ['ID_TIPO_DOCUMENTO', 'DESCRICAO']);
end;

procedure TFrmCadastroRH.PreencherPortadoresRH;
var TipoES: Integer;
begin
  TipoES := 2; // default all
  if cbxTipoOperacaoRH.AsInteger = 0 then
    TipoES := 0 // Entrada (Cr√©dito)
  else if cbxTipoOperacaoRH.AsInteger = 1 then
    TipoES := 1 // Saida (D√©bito)
  else if cbxTipoOperacaoRH.AsInteger = 2 then
    TipoES := 1; // Saldo (D√©bito)
  
  cds.Limpar(cdsSistema);
  cdsSistema.Data := DalDiversos.SqlBuscarPortadoresComboBox(TipoES, cbxEmpresaRH.AsFloat);
  cbxPortadorRH.Preencher(cdsSistema, ['ID_PORTADOR', 'DESCRICAO']);
end;

procedure TFrmCadastroRH.cbxTipoOperacaoRHChange(Sender: TObject);
begin
  PreencherTiposDocumentosRH;
  PreencherPortadoresRH;
end;
```

---

### **PASSO 4: Atualizar cbxTipoOperacaoRHCloseUp**

üìç **Localiza√ß√£o:** Por volta da linha 1483

**ANTES:**
```pascal
procedure TFrmCadastroRH.cbxTipoOperacaoRHCloseUp(Sender: TObject);
begin
  inherited;

  if cbxTipoOperacaoRH.AsInteger = 2 then
  begin
    txtValorRH.AsFloat := 0;
    cbxFechamentoRH.MostrarValor(1);
    ckbCriarRH.MostrarValor(1);
  end;

end;
```

**DEPOIS:**
```pascal
procedure TFrmCadastroRH.cbxTipoOperacaoRHCloseUp(Sender: TObject);
begin
  inherited;

  if cbxTipoOperacaoRH.AsInteger = 2 then
  begin
    txtValorRH.AsFloat := 0;
    cbxFechamentoRH.MostrarValor(1);
    ckbCriarRH.MostrarValor(1);
  end;
  
  cbxTipoOperacaoRHChange(Sender);
end;
```

---

### **PASSO 5: Atualizar cbxTipoOperacaoRHKeyUp**

üìç **Localiza√ß√£o:** Por volta da linha 1496

**ANTES:**
```pascal
procedure TFrmCadastroRH.cbxTipoOperacaoRHKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;
  if cbxTipoOperacaoRH.AsInteger = 2 then
  begin
    txtValorRH.AsFloat := 0;
    cbxFechamentoRH.MostrarValor(1);
    ckbCriarRH.MostrarValor(1);
  end;
end;
```

**DEPOIS:**
```pascal
procedure TFrmCadastroRH.cbxTipoOperacaoRHKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;
  if cbxTipoOperacaoRH.AsInteger = 2 then
  begin
    txtValorRH.AsFloat := 0;
    cbxFechamentoRH.MostrarValor(1);
    ckbCriarRH.MostrarValor(1);
  end;
  
  cbxTipoOperacaoRHChange(Sender);
end;
```

---

## üìÇ ARQUIVO 2: `uFrmCadastroLancamentoRH.pas`

### **PASSO 1: Adicionar declara√ß√£o dos m√©todos (Se√ß√£o Protected)**

üìç **Localiza√ß√£o:** Por volta da linha 368, antes de `public`

**Encontre:**
```pascal
    procedure LojaContaModificar;
    procedure QuantidadeRegistroMassa;
    function LancamentoEmMassaRH: Boolean;
  public
    { Public declarations }
```

**Substitua por:**
```pascal
    procedure LojaContaModificar;
    procedure QuantidadeRegistroMassa;
    function LancamentoEmMassaRH: Boolean;
    
    procedure PreencherPortadoresRH;
    procedure PreencherTiposDocumentosRH;
  public
    { Public declarations }
```

---

### **PASSO 2: Modificar o CarregarCombos**

üìç **Localiza√ß√£o:** Por volta da linha 1957

**ANTES:**
```pascal
procedure TFrmCadastroLancamentoRH.CarregarCombos;
begin
  inherited;
  // cdsAux1.Data := Dados.BuscarGeral('TABELA', 'DESCRICAO');
  // cbxVisEmpresas.Preencher(cdsAux1, [0, 1]);

  // Buscar campos antes de fazer a buscar
  cds.Limpar(cdsAux1);
  cdsAux1.Data := Dados.SqlBuscarEmpresas;
  cbxVisIdEmpresaCad.Preencher(cdsAux1, [0, 1], -1, True);
  cbxVisIdEmpresaCad2.Preencher(cdsAux1, [0, 1], -1, True);
  cbxEmpresaRH.Preencher(cdsAux1, [0, 1]);

  cds.Limpar(cdsSistema);
  cdsSistema.Data := Dados.BuscarGeral('TIPOS_DOCUMENTOS', 'DESCRICAO');
  cbxTipoDocumentoRH.Preencher(cdsSistema, ['ID_TIPO_DOCUMENTO', 'DESCRICAO']);

  cds.Limpar(cdsSistema);
  cdsSistema.Data := Dados.BuscarGeral('PORTADORES', 'DESCRICAO');
  cbxPortadorRH.Preencher(cdsSistema, ['ID_PORTADOR', 'DESCRICAO']);

end;
```

**DEPOIS:**
```pascal
procedure TFrmCadastroLancamentoRH.CarregarCombos;
begin
  inherited;
  // cdsAux1.Data := Dados.BuscarGeral('TABELA', 'DESCRICAO');
  // cbxVisEmpresas.Preencher(cdsAux1, [0, 1]);

  // Buscar campos antes de fazer a buscar
  cds.Limpar(cdsAux1);
  cdsAux1.Data := Dados.SqlBuscarEmpresas;
  cbxVisIdEmpresaCad.Preencher(cdsAux1, [0, 1], -1, True);
  cbxVisIdEmpresaCad2.Preencher(cdsAux1, [0, 1], -1, True);
  cbxEmpresaRH.Preencher(cdsAux1, [0, 1]);

  PreencherTiposDocumentosRH;
  PreencherPortadoresRH;
  cbxTipoOperacaoRH.OnChange := cbxTipoOperacaoRHChange;
end;
```

---

### **PASSO 3: Adicionar os NOVOS m√©todos**

üìç **Localiza√ß√£o:** Logo ap√≥s o m√©todo `CarregarCombos`

**Adicione estes 3 m√©todos:**

```pascal
procedure TFrmCadastroLancamentoRH.PreencherTiposDocumentosRH;
var TipoES: Integer;
begin
  TipoES := 2; // default all
  if cbxTipoOperacaoRH.AsInteger = 0 then
    TipoES := 0 // Entrada (Cr√©dito)
  else if cbxTipoOperacaoRH.AsInteger = 1 then
    TipoES := 1 // Saida (D√©bito)
  else if cbxTipoOperacaoRH.AsInteger = 2 then
    TipoES := 1; // Saldo (D√©bito)
  
  cds.Limpar(cdsSistema);
  if TipoES = 2 then
    cdsSistema.Data := Dados.BuscarGeral('TIPOS_DOCUMENTOS', 'DESCRICAO')
  else
  begin
    cdsSistema.Data := Dados.QryOpenOle(
      'SELECT * FROM TIPOS_DOCUMENTOS WHERE (TP_ENTRADA_SAIDA = ' + TipoES.ToString + ' OR TP_ENTRADA_SAIDA = 2) ORDER BY DESCRICAO');
  end;
  cbxTipoDocumentoRH.Preencher(cdsSistema, ['ID_TIPO_DOCUMENTO', 'DESCRICAO']);
end;

procedure TFrmCadastroLancamentoRH.PreencherPortadoresRH;
var TipoES: Integer;
begin
  TipoES := 2; // default all
  if cbxTipoOperacaoRH.AsInteger = 0 then
    TipoES := 0 // Entrada (Cr√©dito)
  else if cbxTipoOperacaoRH.AsInteger = 1 then
    TipoES := 1 // Saida (D√©bito)
  else if cbxTipoOperacaoRH.AsInteger = 2 then
    TipoES := 1; // Saldo (D√©bito)
  
  cds.Limpar(cdsSistema);
  cdsSistema.Data := DalDiversos.SqlBuscarPortadoresComboBox(TipoES, cbxEmpresaRH.AsFloat);
  cbxPortadorRH.Preencher(cdsSistema, ['ID_PORTADOR', 'DESCRICAO']);
end;

procedure TFrmCadastroLancamentoRH.cbxTipoOperacaoRHChange(Sender: TObject);
begin
  PreencherTiposDocumentosRH;
  PreencherPortadoresRH;
end;
```

---

## ‚úÖ CHECKLIST DOS T√ìPICOS DO SUPERVISOR

| T√≥pico | Status | Onde est√° implementado |
|--------|--------|----------------------|
| **CarregarCombos** | ‚úÖ | Modificado para chamar os novos m√©todos de preenchimento |
| **WHERE no SELECT de portadores** | ‚úÖ | Usa `DalDiversos.SqlBuscarPortadoresComboBox(TipoES, ...)` que j√° tem o WHERE correto |
| **cbxOperacaoOnExit ‚Üí opera√ß√£o** | ‚úÖ | Implementado via `cbxTipoOperacaoRHChange` chamado no CloseUp e KeyUp |
| **Corrigir combobox de portadores** | ‚úÖ | M√©todo `PreencherPortadoresRH` filtra por tipo de opera√ß√£o |
| **Corrigir combobox de tipo de documentos** | ‚úÖ | M√©todo `PreencherTiposDocumentosRH` filtra por tipo de opera√ß√£o |

---

## üîç L√ìGICA DE FUNCIONAMENTO

### Mapeamento de Opera√ß√µes:

| Opera√ß√£o Selecionada | AsInteger | TipoES | Filtro Aplicado |
|---------------------|-----------|--------|-----------------|
| *(vazio)* | -1 | 2 | Mostra TODOS |
| **+ CR√âDITO** | 0 | 0 | Mostra ENTRADA ou AMBOS |
| **- D√âBITO** | 1 | 1 | Mostra SA√çDA ou AMBOS |
| **- SALDO** | 2 | 1 | Mostra SA√çDA ou AMBOS |

### Valores no Banco de Dados:

**Tabela PORTADORES / TIPOS_DOCUMENTOS - Campo TP_ENTRADA_SAIDA:**
- `0` = Entrada
- `1` = Sa√≠da  
- `2` = Ambos

### Exemplos Pr√°ticos:

**Cen√°rio 1:** Usu√°rio seleciona **"+ CR√âDITO"**
- TipoES = 0 (Entrada)
- SQL: `WHERE (TP_ENTRADA_SAIDA = 0 OR TP_ENTRADA_SAIDA = 2)`
- Resultado: Mostra apenas portadores marcados como "Entrada" ou "Ambos"
- ‚úÖ N√£o mostrar√° "Compra" (que √© Sa√≠da)

**Cen√°rio 2:** Usu√°rio seleciona **"- D√âBITO"**
- TipoES = 1 (Sa√≠da)
- SQL: `WHERE (TP_ENTRADA_SAIDA = 1 OR TP_ENTRADA_SAIDA = 2)`
- Resultado: Mostra apenas portadores marcados como "Sa√≠da" ou "Ambos"
- ‚úÖ N√£o mostrar√° "Boleto" (que √© Entrada)

**Cen√°rio 3:** Usu√°rio n√£o selecionou nada
- TipoES = 2 (Todos)
- SQL: Sem WHERE
- Resultado: Mostra TODOS os portadores/documentos

---

## üé¨ FLUXO DE EXECU√á√ÉO

1. **Ao abrir o formul√°rio:**
   - `CarregarCombos` √© chamado
   - `PreencherTiposDocumentosRH` executa com TipoES = 2 (mostra todos)
   - `PreencherPortadoresRH` executa com TipoES = 2 (mostra todos)
   - Atribui evento `OnChange` ao combo de opera√ß√£o

2. **Quando usu√°rio altera a opera√ß√£o:**
   - `cbxTipoOperacaoRHCloseUp` ou `cbxTipoOperacaoRHKeyUp` √© disparado
   - Chama `cbxTipoOperacaoRHChange`
   - `PreencherTiposDocumentosRH` recarrega com filtro
   - `PreencherPortadoresRH` recarrega com filtro
   - Usu√°rio v√™ apenas op√ß√µes compat√≠veis

3. **Ao salvar:**
   - Valida√ß√£o existente continua verificando compatibilidade
   - Mas agora o usu√°rio N√ÉO consegue selecionar op√ß√µes incompat√≠veis
   - ‚úÖ Problema resolvido preventivamente!

---

## üí° OBSERVA√á√ïES IMPORTANTES

### Por que usar `DalDiversos.SqlBuscarPortadoresComboBox`?

Esta fun√ß√£o J√Å EXISTE no sistema e foi criada especificamente para filtrar portadores por tipo de entrada/sa√≠da. Ela:

1. ‚úÖ J√° tem o WHERE correto implementado
2. ‚úÖ J√° considera o filtro por empresa
3. ‚úÖ J√° √© usada no m√≥dulo ContasPR (que funciona corretamente)
4. ‚úÖ Retorna os portadores ordenados por descri√ß√£o

### Tipos de Documentos

Para tipos de documentos, fazemos query direta pois √© mais simples:
```sql
SELECT * FROM TIPOS_DOCUMENTOS 
WHERE (TP_ENTRADA_SAIDA = [TipoES] OR TP_ENTRADA_SAIDA = 2) 
ORDER BY DESCRICAO
```

### Evento OnChange vs OnExit

Usamos **OnChange** porque:
- √â disparado assim que o valor muda
- Funciona tanto com mouse (CloseUp) quanto teclado (KeyUp)
- Garante sincroniza√ß√£o imediata dos combos dependentes

---

## üß™ COMO TESTAR

### Teste 1: Cadastro RH - Opera√ß√£o Cr√©dito
1. Abra **Cadastro RH** (Pessoa_RH)
2. Clique em "Novo"
3. Selecione Opera√ß√£o: **+ CR√âDITO**
4. ‚úÖ Verificar: Combo Portador mostra apenas Entrada/Ambos
5. ‚úÖ Verificar: Combo Tipo Documento mostra apenas Entrada/Ambos
6. ‚ùå N√£o deve aparecer: Portadores de Sa√≠da (ex: Compra)

### Teste 2: Cadastro RH - Opera√ß√£o D√©bito
1. Abra **Cadastro RH**
2. Clique em "Novo"
3. Selecione Opera√ß√£o: **- D√âBITO**
4. ‚úÖ Verificar: Combo Portador mostra apenas Sa√≠da/Ambos
5. ‚úÖ Verificar: Combo Tipo Documento mostra apenas Sa√≠da/Ambos
6. ‚ùå N√£o deve aparecer: Portadores de Entrada (ex: Boleto)

### Teste 3: Lan√ßamento RH - Mudan√ßa de Opera√ß√£o
1. Abra **Lan√ßamento RH**
2. Clique em "Novo"
3. Selecione Opera√ß√£o: **+ CR√âDITO**
4. Observe os portadores dispon√≠veis
5. Mude para: **- D√âBITO**
6. ‚úÖ Verificar: Lista de portadores foi atualizada automaticamente
7. ‚úÖ Verificar: Portadores incompat√≠veis sumiram da lista

### Teste 4: Opera√ß√£o Saldo
1. Abra **Cadastro RH**
2. Selecione Opera√ß√£o: **- SALDO**
3. ‚úÖ Verificar: Comportamento igual ao D√âBITO (TipoES = 1)

---

## üêõ TROUBLESHOOTING

### Problema: "Access Violation" ao mudar opera√ß√£o
**Causa:** Evento OnChange disparando antes do combo estar pronto  
**Solu√ß√£o:** Verificar se cbxTipoOperacaoRH est√° criado antes de atribuir OnChange

### Problema: Combos n√£o atualizam ao mudar opera√ß√£o
**Causa:** Evento OnChange n√£o foi atribu√≠do  
**Solu√ß√£o:** Verificar se linha `cbxTipoOperacaoRH.OnChange := cbxTipoOperacaoRHChange;` est√° no CarregarCombos

### Problema: Erro de compila√ß√£o "Undeclared identifier"
**Causa:** M√©todos n√£o declarados na se√ß√£o protected  
**Solu√ß√£o:** Adicionar declara√ß√µes no PASSO 1 de cada arquivo

---

## üìù RESUMO DAS ALTERA√á√ïES

### Arquivos Modificados:
- ‚úèÔ∏è `Sol.NET\Form\uFrmCadastroRH.pas`
- ‚úèÔ∏è `Sol.NET\Form\uFrmCadastroLancamentoRH.pas`

### M√©todos Adicionados (em cada arquivo):
- `PreencherPortadoresRH` - Filtra portadores por opera√ß√£o
- `PreencherTiposDocumentosRH` - Filtra tipos de documentos por opera√ß√£o  
- `cbxTipoOperacaoRHChange` - Evento de mudan√ßa de opera√ß√£o

### M√©todos Modificados (em cada arquivo):
- `CarregarCombos` - Chama novos m√©todos e atribui evento
- `cbxTipoOperacaoRHCloseUp` - Adiciona chamada ao Change
- `cbxTipoOperacaoRHKeyUp` - Adiciona chamada ao Change

---

## ‚ú® BENEF√çCIOS DA SOLU√á√ÉO

1. ‚úÖ **Preven√ß√£o de Erro:** Usu√°rio n√£o consegue mais selecionar op√ß√µes incompat√≠veis
2. ‚úÖ **UX Melhorada:** Interface mais intuitiva, mostra apenas op√ß√µes v√°lidas
3. ‚úÖ **Consist√™ncia:** Mesmo comportamento de ContasPR
4. ‚úÖ **Manutenibilidade:** Usa fun√ß√µes existentes e testadas
5. ‚úÖ **Performance:** Filtra no banco, n√£o no cliente
6. ‚úÖ **Escal√°vel:** F√°cil adicionar novos tipos de opera√ß√£o se necess√°rio

---

**Desenvolvido por:** GitHub Copilot  
**Data:** 25/11/2025  
**Vers√£o do Guia:** 1.0
